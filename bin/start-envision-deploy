#!/bin/bash

# session name
sn=deploy

# List production instances
prod_instances=$(heroku apps | cut -d ' ' -f 1 | grep ^e7- | grep -v ^e7-central)

# Create windows for each envision instances
index=1
for instance in $prod_instances; do
  # First window is a new session
  if [ $index == 1 ]; then
    tmux new-session -s "$sn" -n $instance -d "APP_NAME=$instance $SHELL"
  else
    tmux new-window -t "$sn:$index" -n $instance "APP_NAME=$instance $SHELL"
  fi
  # Initiate a backup when --backup supplied
  if [ "$1" == "--backup" ]; then
    tmux send-keys -t "$sn:$index" 'heroku pg:backups capture --expire --app $APP_NAME' Enter
  fi

  index=$(($index + 1))
done

# Select window #1 and attach to the session
tmux select-window -t "$sn:1"
tmux -2 attach-session -t "$sn"
